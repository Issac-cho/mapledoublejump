<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í—¤ë„¤ì‹œìŠ¤ ë©€í‹°í”Œë ˆì´ í…ŒìŠ¤íŠ¸ + ì±„íŒ…</title>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

<style>
body{
    margin:0;
    background:#1e1e1e;
    font-family:'Malgun Gothic', sans-serif;
    overflow: hidden; /* ìŠ¤í¬ë¡¤ë°” ë°©ì§€ */
}

/* ë¡œê·¸ì¸ ì¤‘ì•™ ì •ë ¬ */
.center-wrapper{
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    padding:20px;
    box-sizing:border-box;
    position: relative;
    z-index: 10; /* ê²Œì„ í™”ë©´ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ */
}

/* ë¡œê·¸ì¸ íŒ¨ë„ */
.panel{
    width:100%;
    max-width:420px;
    background:white;
    padding:32px;
    border-radius:14px;
    box-shadow:0 10px 35px rgba(0,0,0,0.25);
    text-align:center;
}

.panel h2{ margin:0 0 15px 0; white-space:nowrap; }
.panel input{ width:100%; padding:12px; margin-top:10px; margin-bottom:14px; border-radius:10px; border:1px solid #ddd; font-size:16px; box-sizing:border-box; }
.panel button{ width:100%; padding:12px; border:none; border-radius:10px; background:#4CAF50; color:white; font-weight:bold; font-size:16px; cursor:pointer; }
.panel button:hover{ background:#43a047; }
.panel .release-btn { width:30%; background: #f3653f; margin-top: 10px; float: right; }
.panel .release-btn:hover { background: #e0532d; }

/* ê²Œì„ í™”ë©´ ì˜ì—­ */
#gameScreen{
    display:none;
    position: absolute;
    top: 0; left: 0;
    width:100vw;
    height:100vh;
}

canvas{ display:block; }

/* ğŸ’¬ ì±„íŒ… ì…ë ¥ UI (ê²Œì„ í™”ë©´ í•˜ë‹¨ì— ê³ ì •) */
#chatContainer {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    background: rgba(0, 0, 0, 0.6);
    padding: 10px;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    box-sizing: border-box;
    z-index: 5; /* ìº”ë²„ìŠ¤ ìœ„ì— ë– ì•¼ í•¨ */
}

#chatInput {
    flex-grow: 1;
    padding: 10px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    outline: none;
}

#chatSendBtn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    background: #FFD700; /* ë©”ì´í”ŒìŠ¤í† ë¦¬ ëŠë‚Œì˜ ë…¸ë€ìƒ‰ */
    color: #333;
    font-weight: bold;
    cursor: pointer;
}
#chatSendBtn:hover { background: #FFC107; }

</style>
</head>

<body>

<div id="loginScreen" class="center-wrapper">
    <div class="panel">
        <h2>ğŸ„ í—¤ë„¤ì‹œìŠ¤ ë”ë¸”ì í”„ Beta ğŸ„</h2>
        <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (ì—”í„° ì…ì¥)">
        <button onclick="joinPlaza()">ê´‘ì¥ ì…ì¥í•˜ê¸°</button>
        <button class="release-btn" onclick="window.location.href='/release/index.html'">ê³µì‹ ë¬¸ì„œ ë³´ê¸°</button>
    </div>
</div>

<div id="voiceControl" style="position: absolute; top: 20px; right: 20px; z-index: 5;">
    <button id="micBtn" onclick="toggleMic()" style="padding: 10px; border-radius: 8px; font-weight: bold; background: #e74c3c; color: white; border: none; cursor: pointer;">
        ğŸ¤ ë§ˆì´í¬ ì¼œê¸° (ë³´ì´ìŠ¤í†¡ ì—°ê²°)
    </button>
</div>

<div id="gameScreen">
    <div id="chatContainer">
        <input type="text" id="chatInput" placeholder="ì±„íŒ…ì„ ì…ë ¥í•˜ì„¸ìš” (Enterë¡œ ì „ì†¡)">
        <button id="chatSendBtn" onclick="sendChatMessage()">ë³´ë‚´ê¸°</button>
    </div>
</div>

<script>

// âš ï¸ ì¤‘ìš”: ì‹¤ì œ EC2 ì£¼ì†Œë‚˜ ë„ë©”ì¸ìœ¼ë¡œ ë³€ê²½ í•„ìš”
const socket = io();

let nickname = "";
let player;
let platforms;
let cursors;
let otherPlayers;
let canDoubleJump = false;
// ì±„íŒ… ì…ë ¥ì„ ë°›ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸ (ì±„íŒ… ì¤‘ ì´ë™ ë°©ì§€ìš©)
let isTyping = false;

let oldPosition = { x:0, y:0, s:'idle', d:'right' };

// ğŸ™ï¸ WebRTC ê´€ë ¨ ë³€ìˆ˜
let localStream = null; // ë‚´ ë§ˆì´í¬ ì˜¤ë””ì˜¤ ë°ì´í„°
const peerConnections = {}; // ë‚˜ì™€ ì—°ê²°ëœ ë‹¤ë¥¸ ìœ ì €ë“¤ì˜ í†µí™” ì—°ê²° ê°ì²´ ëª¨ìŒ
const stunServerConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }, // êµ¬ê¸€ì˜ ë¬´ë£Œ STUN ì„œë²„ (ë‚´ ê³µì¸ IPë¥¼ ì°¾ì•„ì¤Œ)
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

//////////////////////////////////////////////////////////
// DOM ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
//////////////////////////////////////////////////////////

// 1. ë‹‰ë„¤ì„ ì…ë ¥ì°½ ì—”í„°í‚¤ ì²˜ë¦¬
document.getElementById("nicknameInput").addEventListener("keydown", function(e){
    if(e.key === "Enter") joinPlaza();
});

// 2. ì±„íŒ… ì…ë ¥ì°½ ì—”í„°í‚¤ ì²˜ë¦¬
document.getElementById("chatInput").addEventListener("keydown", function(e){
    if(e.key === "Enter") {
        sendChatMessage();
        this.blur();
    }
    e.stopPropagation(); // ì—”í„°í‚¤ê°€ ê²Œì„ ì¡°ì‘ì— ì˜í–¥ ì•ˆ ì£¼ê²Œ ë§‰ìŒ
});

document.addEventListener("keydown", function(e){
    const chatInput = document.getElementById("chatInput");
    const gameScreen = document.getElementById("gameScreen");
    
    // ê²Œì„ í™”ë©´ì´ ì¼œì ¸ ìˆê³ , í˜„ì¬ í¬ì»¤ìŠ¤ê°€ ì±„íŒ…ì°½ì´ ì•„ë‹ ë•Œ 'Enter'ë¥¼ ëˆ„ë¥´ë©´
    if(gameScreen.style.display === "block" && document.activeElement !== chatInput && e.key === "Enter") {
        chatInput.focus();
        e.preventDefault(); // ì±„íŒ…ì°½ì— ì—”í„°í‚¤ê°€ ì…ë ¥ë˜ëŠ” ê²ƒì„ ë°©ì§€
    }
});

// 3. ì±„íŒ… ì…ë ¥ ì¤‘ì—ëŠ” ìºë¦­í„°ê°€ ì›€ì§ì´ì§€ ì•Šë„ë¡ í”Œë˜ê·¸ ì œì–´
const chatInputField = document.getElementById("chatInput");
chatInputField.addEventListener('focus', () => { isTyping = true; });
chatInputField.addEventListener('blur', () => { isTyping = false; });


//////////////////////////////////////////////////////////
// ì…ì¥ ë° ì±„íŒ… ì „ì†¡ í•¨ìˆ˜
//////////////////////////////////////////////////////////

function joinPlaza(){
    const raw = document.getElementById("nicknameInput").value;
    nickname = raw.trim();
    if(nickname.length === 0){ alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
    const regex = /^[ê°€-í£a-zA-Z0-9 ]+$/;
    if(!regex.test(nickname)){ alert("ë‹‰ë„¤ì„ì€ í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }

    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("gameScreen").style.display = "block";

    startGame();
}

// ğŸ’¬ ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
function sendChatMessage() {
    const input = document.getElementById("chatInput");
    const message = input.value.trim();
    if (message.length > 0) {
        // ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡
        socket.emit('chat_message', { message: message });
        input.value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
        input.focus(); // ê³„ì† ì…ë ¥í•  ìˆ˜ ìˆê²Œ í¬ì»¤ìŠ¤ ìœ ì§€
    }
}


//////////////////////////////////////////////////////////
// Phaser ê²Œì„ ë¡œì§
//////////////////////////////////////////////////////////
function startGame(){
    const config = {
        type: Phaser.AUTO,
        width: 800, height: 600,
        parent: "gameScreen",
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
        physics:{ default:'arcade', arcade:{ gravity:{ y:800 }, debug:false } },
        scene:{ preload, create, update }
    };
    new Phaser.Game(config);
}

function preload(){
    this.load.image('sky','https://labs.phaser.io/assets/skies/sky4.png');
    this.load.image('ground','https://labs.phaser.io/assets/sprites/platform.png');
    this.load.spritesheet('dude','https://labs.phaser.io/assets/sprites/dude.png',{ frameWidth:32, frameHeight:48 });
}

function create(){
    this.add.image(400,300,'sky').setScale(2);

    platforms = this.physics.add.staticGroup();
    platforms.create(400,568,'ground').setScale(2).refreshBody();
    platforms.create(600,400,'ground');
    platforms.create(50,250,'ground');
    platforms.create(750,220,'ground');

    player = this.physics.add.sprite(200,450,'dude');
    player.setBounce(0.1);
    player.setCollideWorldBounds(true);

    // ë‚´ ë‹‰ë„¤ì„ (ë°œ ë°‘)
    player.nicknameText = this.add.text(player.x, player.y + 30, nickname, {
        fontSize: '14px', fill: '#ffffff', backgroundColor: 'rgba(0,0,0,0.5)', padding: { x:4, y:2 }
    }).setOrigin(0.5, 0);

    otherPlayers = this.add.group();

    this.anims.create({ key:'left', frames:this.anims.generateFrameNumbers('dude',{ start:0, end:3 }), frameRate:10, repeat:-1 });
    this.anims.create({ key:'turn', frames:[{ key:'dude', frame:4 }], frameRate:20 });
    this.anims.create({ key:'right', frames:this.anims.generateFrameNumbers('dude',{ start:5, end:8 }), frameRate:10, repeat:-1 });

    this.physics.add.collider(player, platforms);
    cursors = this.input.keyboard.createCursorKeys();

    // --- ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---

    const joinGame = () => {
        socket.emit('join_plaza',{ nickname:nickname, x:player.x, y:player.y });
    };
    if(socket.connected) joinGame();
    else socket.on('connect', joinGame);

    socket.on('current_players',(players)=>{
        Object.keys(players).forEach((id)=>{
            if(players[id].id !== socket.id) addOtherPlayer(this, players[id]);
        });
    });

    socket.on('new_player',(info)=>{ addOtherPlayer(this, info); });

    socket.on('player_moved',(info)=>{
        otherPlayers.getChildren().forEach((otherPlayer)=>{
            if(info.id === otherPlayer.playerId){
                otherPlayer.setPosition(info.x, info.y);
                // ë‹‰ë„¤ì„ & ë§í’ì„  ìœ„ì¹˜ ë™ê¸°í™”
                if(otherPlayer.nicknameText) otherPlayer.nicknameText.setPosition(info.x, info.y + 30);
                if(otherPlayer.chatBubble) otherPlayer.chatBubble.setPosition(info.x, info.y - 60);

                if(info.s === 'walk'){
                    if(info.d === 'left') otherPlayer.anims.play('left',true);
                    else otherPlayer.anims.play('right',true);
                } else { otherPlayer.anims.play('turn'); }
            }
        });
    });

    socket.on('player_leave',(id)=>{
        otherPlayers.getChildren().forEach((otherPlayer)=>{
            if(id === otherPlayer.playerId){
                if(otherPlayer.nicknameText) otherPlayer.nicknameText.destroy();
                // ë§í’ì„  ì‚­ì œ
                if(otherPlayer.chatBubble) otherPlayer.chatBubble.destroy();
                otherPlayer.destroy();
            }
        });
    });

    // ğŸ’¬ ì„œë²„ë¡œë¶€í„° ì±„íŒ… ë©”ì‹œì§€ë¥¼ ë°›ì•˜ì„ ë•Œ
    socket.on('chat_updated', (data) => {
        // 1. ëˆ„ê°€ ë³´ëƒˆëŠ”ì§€ ì°¾ê¸°
        let targetSprite = null;
        if (data.id === socket.id) {
            targetSprite = player; // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€
        } else {
            // ë‚¨ì´ ë³´ë‚¸ ë©”ì‹œì§€
            otherPlayers.getChildren().forEach((other) => {
                if (other.playerId === data.id) targetSprite = other;
            });
        }

        // 2. í•´ë‹¹ ìºë¦­í„° ë¨¸ë¦¬ ìœ„ì— ë§í’ì„  ë„ìš°ê¸°
        if (targetSprite) {
            showChatBubble(this, targetSprite, data.message);
        }
    });
}

function addOtherPlayer(scene, info){
    const otherPlayer = scene.add.sprite(info.x, info.y, 'dude');
    otherPlayer.setTint(Math.random()*0xffffff);
    otherPlayer.playerId = info.id;
    otherPlayer.nicknameText = scene.add.text(info.x, info.y + 30, info.nickname || 'ì•Œìˆ˜ì—†ìŒ', {
        fontSize: '14px', fill: '#ffffff', backgroundColor: 'rgba(0,0,0,0.5)', padding: { x:4, y:2 }
    }).setOrigin(0.5, 0);
    otherPlayers.add(otherPlayer);
}

// ğŸ’¬ ë§í’ì„  ìƒì„± ë„ìš°ë¯¸ í•¨ìˆ˜
function showChatBubble(scene, targetSprite, message) {
    // ê¸°ì¡´ ë§í’ì„ ì´ ìˆìœ¼ë©´ ì‚­ì œ (ì¤‘ë³µ ë°©ì§€)
    if (targetSprite.chatBubble) {
        targetSprite.chatBubble.destroy();
        if (targetSprite.chatTimer) targetSprite.chatTimer.remove();
    }

    // ë§í’ì„  í…ìŠ¤íŠ¸ ê°ì²´ ìƒì„± (ìºë¦­í„° ë¨¸ë¦¬ ìœ„ -60px ì§€ì )
    const bubble = scene.add.text(targetSprite.x, targetSprite.y - 60, message, {
        fontFamily: 'Malgun Gothic, sans-serif',
        fontSize: '14px',
        color: '#000000', // ê²€ì€ìƒ‰ ê¸€ì”¨
        backgroundColor: '#ffffff', // í°ìƒ‰ ë°°ê²½
        padding: { x: 10, y: 6 }, // ë‚´ë¶€ ì—¬ë°±
        align: 'center',
        wordWrap: { width: 150, useAdvancedWrap: true } // ë„ˆë¬´ ê¸¸ë©´ ì¤„ë°”ê¿ˆ
    }).setOrigin(0.5, 1); // í•˜ë‹¨ ì¤‘ì•™ì„ ê¸°ì¤€ì ìœ¼ë¡œ ì¡ìŒ

    // í…Œë‘ë¦¬ ì¶”ê°€ (Phaser 3.60 ì´ìƒ ì§€ì›)
    bubble.setStroke('#cccccc', 2);
    
    // ìŠ¤í”„ë¼ì´íŠ¸ì— ì—°ê²°
    targetSprite.chatBubble = bubble;

    // 4ì´ˆ ë’¤ì— ë§í’ì„  ì‚­ì œ íƒ€ì´ë¨¸ ì„¤ì •
    targetSprite.chatTimer = scene.time.delayedCall(4000, () => {
        if (targetSprite.chatBubble) {
            targetSprite.chatBubble.destroy();
            targetSprite.chatBubble = null;
        }
    });
}


function update(){
    if(!player || !player.body) return;

    let currentState = 'idle';
    let currentDirection = oldPosition.d;

    // 1. ìƒíƒœì— ë”°ë¥¸ ì…ë ¥ ì²˜ë¦¬
    if (isTyping) {
        // ğŸ’¬ ì±„íŒ… ì¤‘ì¼ ë•ŒëŠ” ì¢Œìš° ì´ë™ë§Œ ë§‰ìŒ (ì¤‘ë ¥ì— ì˜í•œ ì¶”ë½ì€ ê·¸ëŒ€ë¡œ ì ìš©ë¨)
        player.setVelocityX(0);
        player.anims.play('turn');
    } else {
        // ğŸ® ì •ìƒ ì¡°ì‘ (ì´ë™ ë¡œì§)
        if(cursors.left.isDown){
            player.setVelocityX(-160); player.anims.play('left',true);
            currentState='walk'; currentDirection='left';
        } else if(cursors.right.isDown){
            player.setVelocityX(160); player.anims.play('right',true);
            currentState='walk'; currentDirection='right';
        } else {
            player.setVelocityX(0); player.anims.play('turn');
        }

        const isGrounded = player.body.touching.down;
        const jumpPressed = Phaser.Input.Keyboard.JustDown(cursors.space);
        const upPressed = cursors.up.isDown;
        
        if(isGrounded && jumpPressed){
            player.setVelocityY(-400); canDoubleJump = true;
        } else if(!isGrounded && canDoubleJump && upPressed && jumpPressed){
            player.setVelocityY(-350); canDoubleJump = false;
        }
    }

    // 2. ë‚´ ë‹‰ë„¤ì„ & ë§í’ì„  ìœ„ì¹˜ ë™ê¸°í™” (ìºë¦­í„° ë”°ë¼ë‹¤ë‹ˆê¸°)
    if(player.nicknameText) player.nicknameText.setPosition(player.x, player.y + 30);
    if(player.chatBubble) player.chatBubble.setPosition(player.x, player.y - 60);

    // 3. ğŸ“¡ ì„œë²„ ì „ì†¡ (ìµœì í™”)
    // ì±„íŒ… ì¤‘ì´ì–´ë„, ê³µì¤‘ì—ì„œ ë–¨ì–´ì§€ëŠ” ì¤‘ì´ë¼ë©´ y ì¢Œí‘œê°€ ë³€í•˜ë¯€ë¡œ ì„œë²„ë¡œ ë°ì´í„°ê°€ ë‚ ì•„ê°‘ë‹ˆë‹¤!
    const xChanged = Math.abs(oldPosition.x - player.x) > 1;
    const yChanged = Math.abs(oldPosition.y - player.y) > 1;

    // x, y ì¢Œí‘œê°€ ë³€í–ˆê±°ë‚˜, ëª¨ì…˜/ë°©í–¥ì´ ë³€í–ˆì„ ë•Œ ê°±ì‹ 
    if(xChanged || yChanged || oldPosition.s !== currentState || oldPosition.d !== currentDirection){
        socket.emit('player_move',{ x:player.x, y:player.y, s:currentState, d:currentDirection });
        oldPosition = { x:player.x, y:player.y, s:currentState, d:currentDirection };
    }
}

// ==========================================================
// ğŸ™ï¸ WebRTC ë³´ì´ìŠ¤ ì±„íŒ… ë¡œì§
// ==========================================================

// ë§ˆì´í¬ê°€ ì¼œì ¸ ìˆëŠ”ì§€ ìƒíƒœë¥¼ ê¸°ì–µí•  ë³€ìˆ˜ ì¶”ê°€
let isMicOn = false;

// 1. ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ë° ë‚´ ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸° (í† ê¸€ ê¸°ëŠ¥ ì¶”ê°€)
async function toggleMic() {
    const micBtn = document.getElementById("micBtn");

    // ìƒí™© A: ì²˜ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ë§ˆì´í¬ ê¶Œí•œì„ ì–»ê³  í†µí™”ë¥¼ ì‹œì‘í•  ë•Œ
    if (!localStream) {
        try {
            // ë¸Œë¼ìš°ì €ì— ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            isMicOn = true;
            
            micBtn.innerText = "ğŸ™ï¸ ë§ˆì´í¬ ì¼œì§ (ëˆ„ë¥´ë©´ ìŒì†Œê±°)";
            micBtn.style.background = "#4CAF50"; // ì´ˆë¡ìƒ‰
            
            console.log("ë§ˆì´í¬ê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤! ë‹¤ë¥¸ ìœ ì €ë“¤ê³¼ í†µí™” ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.");

            // ì´ë¯¸ ê´‘ì¥ì— ìˆëŠ” ìœ ì €ë“¤ì—ê²Œ ë‚´ê°€ ì „í™”ë¥¼ ê²€ (Offer)
            otherPlayers.getChildren().forEach((other) => {
                makeWebRTCConnection(other.playerId, true);
            });
        } catch (err) {
            alert("ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ ë³´ì´ìŠ¤ ì±„íŒ…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
            console.error("ë§ˆì´í¬ ì˜¤ë¥˜:", err);
        }
        return; // ì²˜ìŒ ì¼°ì„ ë•ŒëŠ” ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œ
    }

    // ìƒí™© B: ì´ë¯¸ ë§ˆì´í¬ê°€ ì¼œì ¸ ìˆì–´ì„œ ë„ê±°ë‚˜(Mute) ë‹¤ì‹œ ì¼¤(Unmute) ë•Œ
    const audioTrack = localStream.getAudioTracks()[0];
    if (audioTrack) {
        isMicOn = !isMicOn; // ìƒíƒœ ë’¤ì§‘ê¸° (true <-> false)
        audioTrack.enabled = isMicOn; // í•µì‹¬: trueë©´ ì „ì†¡, falseë©´ ì†Œë¦¬ ì „ì†¡ ì°¨ë‹¨(ìŒì†Œê±°)

        if (isMicOn) {
            micBtn.innerText = "ğŸ™ï¸ ë§ˆì´í¬ ì¼œì§ (ëˆ„ë¥´ë©´ ìŒì†Œê±°)";
            micBtn.style.background = "#4CAF50"; // ë‹¤ì‹œ ì´ˆë¡ìƒ‰
        } else {
            micBtn.innerText = "ğŸ”‡ ë§ˆì´í¬ êº¼ì§ (ëˆ„ë¥´ë©´ ì¼œì§)";
            micBtn.style.background = "#e74c3c"; // ë‹¤ì‹œ ë¹¨ê°„ìƒ‰
        }
    }
}

// 2. 1:1 í†µí™” ì—°ê²°(PeerConnection) ê°ì²´ ìƒì„±
function makeWebRTCConnection(targetId, isCaller) {
    if (peerConnections[targetId]) return; // ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ íŒ¨ìŠ¤

    const rtcPeerConnection = new RTCPeerConnection(stunServerConfig);
    peerConnections[targetId] = rtcPeerConnection;

    // ë‚´ ë§ˆì´í¬ ì†Œë¦¬ë¥¼ ì—°ê²°ì„ ì— ì˜¬ë¦¼
    if (localStream) {
        localStream.getTracks().forEach(track => rtcPeerConnection.addTrack(track, localStream));
    }

    // ìƒëŒ€ë°©ì˜ ì†Œë¦¬ê°€ ë„ì°©í•˜ë©´ ì²˜ë¦¬í•  ì´ë²¤íŠ¸
    rtcPeerConnection.ontrack = (event) => {
        // í™”ë©´ì— ì•ˆ ë³´ì´ëŠ” <audio> íƒœê·¸ë¥¼ ë§Œë“¤ì–´ ìƒëŒ€ë°© ì†Œë¦¬ë¥¼ ì¬ìƒ
        let audioElement = document.getElementById(`audio-${targetId}`);
        if (!audioElement) {
            audioElement = document.createElement('audio');
            audioElement.id = `audio-${targetId}`;
            audioElement.autoplay = true;
            document.body.appendChild(audioElement);
        }
        audioElement.srcObject = event.streams[0];
    };

    // ë‚´ ë„¤íŠ¸ì›Œí¬ ëª…í•¨(ICE)ì´ ìƒì„±ë˜ë©´ ì„œë²„ë¥¼ í†µí•´ ìƒëŒ€ì—ê²Œ ì „ë‹¬
    rtcPeerConnection.onicecandidate = (event) => {
        if (event.candidate) {
            socket.emit('webrtc_ice_candidate', { target: targetId, candidate: event.candidate });
        }
    };

    // ë‚´ê°€ ì „í™”ë¥¼ ê±°ëŠ” ì…ì¥(Caller)ì´ë¼ë©´ ì´ˆëŒ€ì¥(Offer) ìƒì„±
    if (isCaller) {
        rtcPeerConnection.createOffer()
            .then(offer => {
                rtcPeerConnection.setLocalDescription(offer);
                socket.emit('webrtc_offer', { target: targetId, sdp: offer });
            });
    }
}

// 3. ì„œë²„ì—ì„œ ì¤‘ë§¤(Signaling) ë°ì´í„°ë¥¼ ë°›ì•˜ì„ ë•Œì˜ ì²˜ë¦¬

// ëˆ„êµ°ê°€ ë‚˜ì—ê²Œ í†µí™” ì´ˆëŒ€ì¥(Offer)ì„ ë³´ëƒ„
socket.on('webrtc_offer', async (data) => {
    makeWebRTCConnection(data.caller, false);
    const rtcPeerConnection = peerConnections[data.caller];
    
    await rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
    const answer = await rtcPeerConnection.createAnswer(); // ìˆ˜ë½ì¥ ìƒì„±
    await rtcPeerConnection.setLocalDescription(answer);
    
    socket.emit('webrtc_answer', { target: data.caller, sdp: answer });
});

// ìƒëŒ€ë°©ì´ ë‚´ ì´ˆëŒ€ë¥¼ ìˆ˜ë½(Answer)í•¨
socket.on('webrtc_answer', async (data) => {
    const rtcPeerConnection = peerConnections[data.callee];
    await rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
});

// ìƒëŒ€ë°©ì˜ ë„¤íŠ¸ì›Œí¬ ëª…í•¨(ICE)ì„ ë°›ìŒ
socket.on('webrtc_ice_candidate', async (data) => {
    const rtcPeerConnection = peerConnections[data.sender];
    if (rtcPeerConnection) {
        await rtcPeerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
    }
});

// ìœ ì €ê°€ ë‚˜ê°€ë©´ í†µí™”ë„ ëŠê¸° (ê¸°ì¡´ player_leave ì´ë²¤íŠ¸ ë¡œì§ê³¼ í•¨ê»˜ ì‘ë™)
socket.on('player_leave', (id) => {
    if (peerConnections[id]) {
        peerConnections[id].close();
        delete peerConnections[id];
        
        // ë§Œë“¤ì–´ë’€ë˜ <audio> íƒœê·¸ë„ ì‚­ì œ
        const audioElement = document.getElementById(`audio-${id}`);
        if (audioElement) audioElement.remove();
    }
});
</script>
</body>
</html>