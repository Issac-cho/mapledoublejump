<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í—¤ë„¤ì‹œìŠ¤ ë©€í‹°í”Œë ˆì´ í…ŒìŠ¤íŠ¸ + ì±„íŒ…</title>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

<style>
body{
    margin:0;
    background:#1e1e1e;
    font-family:'Malgun Gothic', sans-serif;
    overflow: hidden; /* ìŠ¤í¬ë¡¤ë°” ë°©ì§€ */
}

/* ë¡œê·¸ì¸ ì¤‘ì•™ ì •ë ¬ */
.center-wrapper{
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    padding:20px;
    box-sizing:border-box;
    position: relative;
    z-index: 10; /* ê²Œì„ í™”ë©´ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ */
}

/* ë¡œê·¸ì¸ íŒ¨ë„ */
.panel{
    width:100%;
    max-width:420px;
    background:white;
    padding:32px;
    border-radius:14px;
    box-shadow:0 10px 35px rgba(0,0,0,0.25);
    text-align:center;
}

.panel h2{ margin:0 0 15px 0; white-space:nowrap; }
.panel input{ width:100%; padding:12px; margin-top:10px; margin-bottom:14px; border-radius:10px; border:1px solid #ddd; font-size:16px; box-sizing:border-box; }
.panel button{ width:100%; padding:12px; border:none; border-radius:10px; background:#4CAF50; color:white; font-weight:bold; font-size:16px; cursor:pointer; }
.panel button:hover{ background:#43a047; }

/* ê²Œì„ í™”ë©´ ì˜ì—­ */
#gameScreen{
    display:none;
    position: absolute;
    top: 0; left: 0;
    width:100vw;
    height:100vh;
}

canvas{ display:block; }

/* ğŸ’¬ ì±„íŒ… ì…ë ¥ UI (ê²Œì„ í™”ë©´ í•˜ë‹¨ì— ê³ ì •) */
#chatContainer {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    background: rgba(0, 0, 0, 0.6);
    padding: 10px;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    box-sizing: border-box;
    z-index: 5; /* ìº”ë²„ìŠ¤ ìœ„ì— ë– ì•¼ í•¨ */
}

#chatInput {
    flex-grow: 1;
    padding: 10px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    outline: none;
}

#chatSendBtn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    background: #FFD700; /* ë©”ì´í”ŒìŠ¤í† ë¦¬ ëŠë‚Œì˜ ë…¸ë€ìƒ‰ */
    color: #333;
    font-weight: bold;
    cursor: pointer;
}
#chatSendBtn:hover { background: #FFC107; }

</style>
</head>

<body>

<div id="loginScreen" class="center-wrapper">
    <div class="panel">
        <h2>ğŸ„ í—¤ë„¤ì‹œìŠ¤ ë”ë¸”ì í”„ Beta ğŸ„</h2>
        <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (ì—”í„° ì…ì¥)">
        <button onclick="joinPlaza()">ê´‘ì¥ ì…ì¥í•˜ê¸°</button>
    </div>
</div>

<div id="gameScreen">
    <div id="chatContainer">
        <input type="text" id="chatInput" placeholder="ì±„íŒ…ì„ ì…ë ¥í•˜ì„¸ìš” (Enterë¡œ ì „ì†¡)">
        <button id="chatSendBtn" onclick="sendChatMessage()">ë³´ë‚´ê¸°</button>
    </div>
</div>

<script>

// âš ï¸ ì¤‘ìš”: ì‹¤ì œ EC2 ì£¼ì†Œë‚˜ ë„ë©”ì¸ìœ¼ë¡œ ë³€ê²½ í•„ìš”
const socket = io('http://localhost:3000');

let nickname = "";
let player;
let platforms;
let cursors;
let otherPlayers;
let canDoubleJump = false;
// ì±„íŒ… ì…ë ¥ì„ ë°›ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸ (ì±„íŒ… ì¤‘ ì´ë™ ë°©ì§€ìš©)
let isTyping = false;

let oldPosition = { x:0, y:0, s:'idle', d:'right' };

//////////////////////////////////////////////////////////
// DOM ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
//////////////////////////////////////////////////////////

// 1. ë‹‰ë„¤ì„ ì…ë ¥ì°½ ì—”í„°í‚¤ ì²˜ë¦¬
document.getElementById("nicknameInput").addEventListener("keydown", function(e){
    if(e.key === "Enter") joinPlaza();
});

// 2. ì±„íŒ… ì…ë ¥ì°½ ì—”í„°í‚¤ ì²˜ë¦¬
document.getElementById("chatInput").addEventListener("keydown", function(e){
    if(e.key === "Enter") {
        sendChatMessage();
        this.blur();
    }
    e.stopPropagation(); // ì—”í„°í‚¤ê°€ ê²Œì„ ì¡°ì‘ì— ì˜í–¥ ì•ˆ ì£¼ê²Œ ë§‰ìŒ
});

document.addEventListener("keydown", function(e){
    const chatInput = document.getElementById("chatInput");
    const gameScreen = document.getElementById("gameScreen");
    
    // ê²Œì„ í™”ë©´ì´ ì¼œì ¸ ìˆê³ , í˜„ì¬ í¬ì»¤ìŠ¤ê°€ ì±„íŒ…ì°½ì´ ì•„ë‹ ë•Œ 'Enter'ë¥¼ ëˆ„ë¥´ë©´
    if(gameScreen.style.display === "block" && document.activeElement !== chatInput && e.key === "Enter") {
        chatInput.focus();
        e.preventDefault(); // ì±„íŒ…ì°½ì— ì—”í„°í‚¤ê°€ ì…ë ¥ë˜ëŠ” ê²ƒì„ ë°©ì§€
    }
});

// 3. ì±„íŒ… ì…ë ¥ ì¤‘ì—ëŠ” ìºë¦­í„°ê°€ ì›€ì§ì´ì§€ ì•Šë„ë¡ í”Œë˜ê·¸ ì œì–´
const chatInputField = document.getElementById("chatInput");
chatInputField.addEventListener('focus', () => { isTyping = true; });
chatInputField.addEventListener('blur', () => { isTyping = false; });


//////////////////////////////////////////////////////////
// ì…ì¥ ë° ì±„íŒ… ì „ì†¡ í•¨ìˆ˜
//////////////////////////////////////////////////////////

function joinPlaza(){
    const raw = document.getElementById("nicknameInput").value;
    nickname = raw.trim();
    if(nickname.length === 0){ alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
    const regex = /^[ê°€-í£a-zA-Z0-9 ]+$/;
    if(!regex.test(nickname)){ alert("ë‹‰ë„¤ì„ì€ í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }

    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("gameScreen").style.display = "block";

    startGame();
}

// ğŸ’¬ ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
function sendChatMessage() {
    const input = document.getElementById("chatInput");
    const message = input.value.trim();
    if (message.length > 0) {
        // ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡
        socket.emit('chat_message', { message: message });
        input.value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
        input.focus(); // ê³„ì† ì…ë ¥í•  ìˆ˜ ìˆê²Œ í¬ì»¤ìŠ¤ ìœ ì§€
    }
}


//////////////////////////////////////////////////////////
// Phaser ê²Œì„ ë¡œì§
//////////////////////////////////////////////////////////
function startGame(){
    const config = {
        type: Phaser.AUTO,
        width: 800, height: 600,
        parent: "gameScreen",
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
        physics:{ default:'arcade', arcade:{ gravity:{ y:800 }, debug:false } },
        scene:{ preload, create, update }
    };
    new Phaser.Game(config);
}

function preload(){
    this.load.image('sky','https://labs.phaser.io/assets/skies/sky4.png');
    this.load.image('ground','https://labs.phaser.io/assets/sprites/platform.png');
    this.load.spritesheet('dude','https://labs.phaser.io/assets/sprites/dude.png',{ frameWidth:32, frameHeight:48 });
}

function create(){
    this.add.image(400,300,'sky').setScale(2);

    platforms = this.physics.add.staticGroup();
    platforms.create(400,568,'ground').setScale(2).refreshBody();
    platforms.create(600,400,'ground');
    platforms.create(50,250,'ground');
    platforms.create(750,220,'ground');

    player = this.physics.add.sprite(200,450,'dude');
    player.setBounce(0.1);
    player.setCollideWorldBounds(true);

    // ë‚´ ë‹‰ë„¤ì„ (ë°œ ë°‘)
    player.nicknameText = this.add.text(player.x, player.y + 30, nickname, {
        fontSize: '14px', fill: '#ffffff', backgroundColor: 'rgba(0,0,0,0.5)', padding: { x:4, y:2 }
    }).setOrigin(0.5, 0);

    otherPlayers = this.add.group();

    this.anims.create({ key:'left', frames:this.anims.generateFrameNumbers('dude',{ start:0, end:3 }), frameRate:10, repeat:-1 });
    this.anims.create({ key:'turn', frames:[{ key:'dude', frame:4 }], frameRate:20 });
    this.anims.create({ key:'right', frames:this.anims.generateFrameNumbers('dude',{ start:5, end:8 }), frameRate:10, repeat:-1 });

    this.physics.add.collider(player, platforms);
    cursors = this.input.keyboard.createCursorKeys();

    // --- ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---

    const joinGame = () => {
        socket.emit('join_plaza',{ nickname:nickname, x:player.x, y:player.y });
    };
    if(socket.connected) joinGame();
    else socket.on('connect', joinGame);

    socket.on('current_players',(players)=>{
        Object.keys(players).forEach((id)=>{
            if(players[id].id !== socket.id) addOtherPlayer(this, players[id]);
        });
    });

    socket.on('new_player',(info)=>{ addOtherPlayer(this, info); });

    socket.on('player_moved',(info)=>{
        otherPlayers.getChildren().forEach((otherPlayer)=>{
            if(info.id === otherPlayer.playerId){
                otherPlayer.setPosition(info.x, info.y);
                // ë‹‰ë„¤ì„ & ë§í’ì„  ìœ„ì¹˜ ë™ê¸°í™”
                if(otherPlayer.nicknameText) otherPlayer.nicknameText.setPosition(info.x, info.y + 30);
                if(otherPlayer.chatBubble) otherPlayer.chatBubble.setPosition(info.x, info.y - 60);

                if(info.s === 'walk'){
                    if(info.d === 'left') otherPlayer.anims.play('left',true);
                    else otherPlayer.anims.play('right',true);
                } else { otherPlayer.anims.play('turn'); }
            }
        });
    });

    socket.on('player_leave',(id)=>{
        otherPlayers.getChildren().forEach((otherPlayer)=>{
            if(id === otherPlayer.playerId){
                if(otherPlayer.nicknameText) otherPlayer.nicknameText.destroy();
                // ë§í’ì„  ì‚­ì œ
                if(otherPlayer.chatBubble) otherPlayer.chatBubble.destroy();
                otherPlayer.destroy();
            }
        });
    });

    // ğŸ’¬ ì„œë²„ë¡œë¶€í„° ì±„íŒ… ë©”ì‹œì§€ë¥¼ ë°›ì•˜ì„ ë•Œ
    socket.on('chat_updated', (data) => {
        // 1. ëˆ„ê°€ ë³´ëƒˆëŠ”ì§€ ì°¾ê¸°
        let targetSprite = null;
        if (data.id === socket.id) {
            targetSprite = player; // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€
        } else {
            // ë‚¨ì´ ë³´ë‚¸ ë©”ì‹œì§€
            otherPlayers.getChildren().forEach((other) => {
                if (other.playerId === data.id) targetSprite = other;
            });
        }

        // 2. í•´ë‹¹ ìºë¦­í„° ë¨¸ë¦¬ ìœ„ì— ë§í’ì„  ë„ìš°ê¸°
        if (targetSprite) {
            showChatBubble(this, targetSprite, data.message);
        }
    });
}

function addOtherPlayer(scene, info){
    const otherPlayer = scene.add.sprite(info.x, info.y, 'dude');
    otherPlayer.setTint(Math.random()*0xffffff);
    otherPlayer.playerId = info.id;
    otherPlayer.nicknameText = scene.add.text(info.x, info.y + 30, info.nickname || 'ì•Œìˆ˜ì—†ìŒ', {
        fontSize: '14px', fill: '#ffffff', backgroundColor: 'rgba(0,0,0,0.5)', padding: { x:4, y:2 }
    }).setOrigin(0.5, 0);
    otherPlayers.add(otherPlayer);
}

// ğŸ’¬ ë§í’ì„  ìƒì„± ë„ìš°ë¯¸ í•¨ìˆ˜
function showChatBubble(scene, targetSprite, message) {
    // ê¸°ì¡´ ë§í’ì„ ì´ ìˆìœ¼ë©´ ì‚­ì œ (ì¤‘ë³µ ë°©ì§€)
    if (targetSprite.chatBubble) {
        targetSprite.chatBubble.destroy();
        if (targetSprite.chatTimer) targetSprite.chatTimer.remove();
    }

    // ë§í’ì„  í…ìŠ¤íŠ¸ ê°ì²´ ìƒì„± (ìºë¦­í„° ë¨¸ë¦¬ ìœ„ -60px ì§€ì )
    const bubble = scene.add.text(targetSprite.x, targetSprite.y - 60, message, {
        fontFamily: 'Malgun Gothic, sans-serif',
        fontSize: '14px',
        color: '#000000', // ê²€ì€ìƒ‰ ê¸€ì”¨
        backgroundColor: '#ffffff', // í°ìƒ‰ ë°°ê²½
        padding: { x: 10, y: 6 }, // ë‚´ë¶€ ì—¬ë°±
        align: 'center',
        wordWrap: { width: 150, useAdvancedWrap: true } // ë„ˆë¬´ ê¸¸ë©´ ì¤„ë°”ê¿ˆ
    }).setOrigin(0.5, 1); // í•˜ë‹¨ ì¤‘ì•™ì„ ê¸°ì¤€ì ìœ¼ë¡œ ì¡ìŒ

    // í…Œë‘ë¦¬ ì¶”ê°€ (Phaser 3.60 ì´ìƒ ì§€ì›)
    bubble.setStroke('#cccccc', 2);
    
    // ìŠ¤í”„ë¼ì´íŠ¸ì— ì—°ê²°
    targetSprite.chatBubble = bubble;

    // 4ì´ˆ ë’¤ì— ë§í’ì„  ì‚­ì œ íƒ€ì´ë¨¸ ì„¤ì •
    targetSprite.chatTimer = scene.time.delayedCall(4000, () => {
        if (targetSprite.chatBubble) {
            targetSprite.chatBubble.destroy();
            targetSprite.chatBubble = null;
        }
    });
}


function update(){
    if(!player || !player.body) return;

    // ğŸ’¬ ì±„íŒ… ì…ë ¥ ì¤‘ì´ë©´ ìºë¦­í„° ì›€ì§ì„ ë§‰ê¸°
    if (isTyping) {
        player.setVelocityX(0);
        player.anims.play('turn');
        // ì›€ì§ì„ì´ ë©ˆì·„ì–´ë„ ë‹‰ë„¤ì„/ë§í’ì„  ìœ„ì¹˜ëŠ” ê³„ì† ë™ê¸°í™”í•´ì¤˜ì•¼ í•¨
        if(player.nicknameText) player.nicknameText.setPosition(player.x, player.y + 30);
        if(player.chatBubble) player.chatBubble.setPosition(player.x, player.y - 60);
        return; 
    }

    // --- ì´ë™ ë¡œì§ ---
    let currentState = 'idle';
    let currentDirection = oldPosition.d;

    if(cursors.left.isDown){
        player.setVelocityX(-160); player.anims.play('left',true);
        currentState='walk'; currentDirection='left';
    } else if(cursors.right.isDown){
        player.setVelocityX(160); player.anims.play('right',true);
        currentState='walk'; currentDirection='right';
    } else {
        player.setVelocityX(0); player.anims.play('turn');
    }

    const isGrounded = player.body.touching.down;
    const jumpPressed = Phaser.Input.Keyboard.JustDown(cursors.space);
    const upPressed = cursors.up.isDown;
    
    if(isGrounded && jumpPressed){
        player.setVelocityY(-400); canDoubleJump = true;
    } else if(!isGrounded && canDoubleJump && upPressed && jumpPressed){
        player.setVelocityY(-350); canDoubleJump = false;
    }

    // ë‚´ ë‹‰ë„¤ì„ & ë§í’ì„  ìœ„ì¹˜ ë™ê¸°í™” (ìºë¦­í„° ë”°ë¼ë‹¤ë‹ˆê¸°)
    if(player.nicknameText) player.nicknameText.setPosition(player.x, player.y + 30);
    if(player.chatBubble) player.chatBubble.setPosition(player.x, player.y - 60);

    // ì„œë²„ ì „ì†¡ (ìµœì í™”)
    const xChanged = Math.abs(oldPosition.x - player.x) > 1;
    const yChanged = Math.abs(oldPosition.y - player.y) > 1;

    if(xChanged || yChanged){
        socket.emit('player_move',{ x:player.x, y:player.y, s:currentState, d:currentDirection });
        oldPosition = { x:player.x, y:player.y, s:currentState, d:currentDirection };
    }
}

</script>
</body>
</html>