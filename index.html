<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í—¤ë„¤ì‹œìŠ¤ ì†Œì¼“ í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background-color: #f4f4f9; }
        .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, button { padding: 8px; margin-right: 5px; }
        #logArea { width: 100%; height: 300px; background: #222; color: #0f0; padding: 10px; font-family: monospace; overflow-y: auto; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="panel">
        <h2>ğŸ„ í—¤ë„¤ì‹œìŠ¤ ì ‘ì†ê¸°</h2>
        <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
        <button onclick="joinPlaza()">ê´‘ì¥ ì…ì¥í•˜ê¸°</button>
    </div>

    <div class="panel" id="actionPanel" style="display: none;">
        <h2>ğŸ® ì•¡ì…˜ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="moveRandom()">ëœë¤ ìœ„ì¹˜ë¡œ ì´ë™ & ë”ë¸”ì í”„ ì˜ê¸°</button>
        <hr style="margin: 15px 0;">
        <input type="text" id="chatInput" placeholder="ì±„íŒ…ì„ ì…ë ¥í•˜ì„¸ìš”">
        <button onclick="sendChat()">ë§í•˜ê¸°</button>
    </div>

    <div class="panel">
        <h2>ğŸ“¡ ì„œë²„ í†µì‹  ë¡œê·¸</h2>
        <div id="logArea"></div>
    </div>

    <script>
        // 1. ì„œë²„ì— ì—°ê²° (ì„œë²„ê°€ 3000ë²ˆ í¬íŠ¸ì—ì„œ ì¼œì ¸ ìˆì–´ì•¼ í•©ë‹ˆë‹¤)
        const socket = io('http://localhost:3000');
        const logArea = document.getElementById('logArea');

        // ë¡œê·¸ ì°ê¸° í—¬í¼ í•¨ìˆ˜
        function writeLog(message) {
            const time = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${time}] ${message}<br>`;
            logArea.scrollTop = logArea.scrollHeight; // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
        }

        socket.on('connect', () => {
            writeLog('ğŸŸ¢ ì„œë²„ì— ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤! (ì†Œì¼“ ID: ' + socket.id + ')');
        });

        // ----------------------------------------------------
        // í´ë¼ì´ì–¸íŠ¸ -> ì„œë²„ (Emit) ë¡œì§
        // ----------------------------------------------------
        
        // ê´‘ì¥ ì…ì¥
        const nicknameInput = document.getElementById("nicknameInput");

        // ì—”í„°í‚¤ë¡œ ì…ì¥
        nicknameInput.addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
                joinPlaza();
            }
        });

        function joinPlaza() {
            const raw = nicknameInput.value;

            // ì•ë’¤ ê³µë°± ì œê±°
            const nickname = raw.trim();

            // 1. ê³µë°±ë§Œ ì…ë ¥ ë°©ì§€
            if (nickname.length === 0) {
                alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            // 2. íŠ¹ìˆ˜ë¬¸ì ì œí•œ (í•œê¸€/ì˜ë¬¸/ìˆ«ì/ê³µë°±ë§Œ í—ˆìš©)
            const regex = /^[ê°€-í£a-zA-Z0-9 ]+$/;

            if (!regex.test(nickname)) {
                alert("ë‹‰ë„¤ì„ì€ í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return;
            }
            socket.emit('join_plaza', {
                nickname: nickname,
                x: 100, y: 100, avatar: 'default_look'
            });
            document.getElementById('actionPanel').style.display = 'block';
            writeLog(`ğŸš€ [ìš”ì²­] '${nickname}' ë‹‰ë„¤ì„ìœ¼ë¡œ ì…ì¥ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`);
        }

        // ëœë¤ ìœ„ì¹˜ë¡œ ì´ë™ (ë”ë¸”ì í”„ ëª¨ì…˜)
        function moveRandom() {
            const randomX = Math.floor(Math.random() * 800);
            const randomY = Math.floor(Math.random() * 600);
            
            socket.emit('player_move', {
                x: randomX, y: randomY, 
                s: 'double_jump', d: 'right'
            });
            writeLog(`ğŸƒâ€â™‚ï¸ [ì´ë™ ì „ì†¡] ë‚´ ìœ„ì¹˜: (${randomX}, ${randomY}), ìƒíƒœ: double_jump`);
        }

        // ì±„íŒ… ë³´ë‚´ê¸°
        function sendChat() {
            const msg = document.getElementById('chatInput').value;
            if(!msg) return;
            
            socket.emit('chat_message', { message: msg });
            writeLog(`ğŸ’¬ [ì±„íŒ… ì „ì†¡] "${msg}"`);
            document.getElementById('chatInput').value = ''; // ì…ë ¥ì°½ ì´ˆê¸°í™”
        }

        // ----------------------------------------------------
        // ì„œë²„ -> í´ë¼ì´ì–¸íŠ¸ (On) ìˆ˜ì‹  ë¡œì§
        // ----------------------------------------------------

        socket.on('current_players', (players) => {
            writeLog(`ğŸ‘¥ [ìˆ˜ì‹ ] í˜„ì¬ ê´‘ì¥ì— ìˆëŠ” ìœ ì € ëª©ë¡ì„ ë°›ì•˜ìŠµë‹ˆë‹¤: ${Object.keys(players).length}ëª…`);
        });

        socket.on('new_player', (player) => {
            writeLog(`âœ¨ [ìˆ˜ì‹ ] ìƒˆë¡œìš´ ìœ ì € ì…ì¥: ${player.nickname} (ì†Œì¼“: ${player.id})`);
        });

        socket.on('player_moved', (data) => {
            writeLog(`ğŸ“ [ìˆ˜ì‹ ] ëˆ„êµ°ê°€ ì´ë™í•¨! (ID: ${data.id}) -> x: ${data.x}, y: ${data.y}, ëª¨ì…˜: ${data.s})`);
        });

        socket.on('chat_updated', (data) => {
            writeLog(`ğŸ—¯ï¸ [ì±„íŒ… ìˆ˜ì‹ ] ${data.nickname}: ${data.message}`);
        });

        socket.on('player_leave', (socketId) => {
            writeLog(`ğŸ‘‹ [ìˆ˜ì‹ ] ìœ ì € í‡´ì¥: ${socketId}`);
        });

    </script>
</body>
</html>